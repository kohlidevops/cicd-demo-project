name: 'Deploy Docker Images'
description: 'Deploy Docker images to specified environment'

inputs:
  environment:
    description: 'Target environment (acceptance, qa, production)'
    required: true
  version:
    description: 'Version tag to deploy'
    required: true
  image-urls:
    description: 'JSON array of image URLs with digests or tags'
    required: true
  ssh-host:
    description: 'SSH host to deploy to'
    required: true
  ssh-user:
    description: 'SSH user'
    required: true
  ssh-key:
    description: 'SSH private key'
    required: true
  github-token:
    description: 'GitHub token for GHCR authentication'
    required: true

runs:
  using: "composite"
  steps:
    - name: Debug Input
      shell: bash
      run: |
        echo "=== DEBUG INFO ==="
        echo "Raw image-urls input: ${{ inputs.image-urls }}"
        echo "Environment: ${{ inputs.environment }}"
        echo "Version: ${{ inputs.version }}"
        echo "=================="

    - name: Parse Image URL
      id: parse
      shell: bash
      run: |
        set -e
        RAW_INPUT='${{ inputs.image-urls }}'
        echo "Raw input: $RAW_INPUT"
        
        # Remove brackets and quotes if it's a JSON array
        IMAGE_URL=$(echo "$RAW_INPUT" | sed 's/^\["//' | sed 's/"\]$//' | sed 's/^"//' | sed 's/"$//')
        
        echo "Parsed IMAGE_URL: $IMAGE_URL"
        
        if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" = "null" ]; then
          echo "âŒ Failed to parse image URL"
          exit 1
        fi
        
        echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
        echo "âœ… Successfully parsed image URL"

    - name: Create Deployment Script
      shell: bash
      run: |
        cat > /tmp/deploy.sh << 'SCRIPT_END'
        #!/bin/bash
        set -e
        
        echo "=== Deployment Starting ==="
        echo "Environment: $ENVIRONMENT"
        echo "Image URL: $IMAGE_URL"
        echo "Version: $VERSION"
        echo "=========================="
        
        # Validate inputs
        if [ -z "$IMAGE_URL" ]; then
          echo "âŒ IMAGE_URL is empty"
          exit 1
        fi
        
        # Login to GHCR
        echo "ðŸ” Logging into GHCR..."
        echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin 2>&1 | grep -v "WARNING" || true
        
        # Pull new image
        echo "â¬‡ï¸  Pulling image: $IMAGE_URL"
        docker pull "$IMAGE_URL"
        
        # Stop existing container
        echo "ðŸ›‘ Stopping existing container..."
        docker stop monolith-app 2>/dev/null || true
        docker rm monolith-app 2>/dev/null || true
        
        # Run new container
        echo "â–¶ï¸  Starting new container..."
        docker run -d \
          --name monolith-app \
          --restart unless-stopped \
          -p 3000:3000 \
          -e NODE_ENV=production \
          -e APP_VERSION="$VERSION" \
          "$IMAGE_URL"
        
        # Wait for application to start
        echo "â³ Waiting for application to start..."
        sleep 10
        
        # Verify deployment with health check
        echo "ðŸ¥ Running health check..."
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "âœ… Health check passed!"
            echo "âœ… Deployment successful!"
            
            echo ""
            echo "ðŸ“Š Container status:"
            docker ps --filter name=monolith-app
            
            echo ""
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" 2>/dev/null || true
            
            echo ""
            echo "ðŸŽ‰ Deployment complete!"
            exit 0
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
          echo "â³ Waiting for health check... attempt $ATTEMPT/$MAX_ATTEMPTS"
          sleep 2
        done
        
        echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
        echo "ðŸ“‹ Container logs:"
        docker logs monolith-app || true
        exit 1
        SCRIPT_END
        
        chmod +x /tmp/deploy.sh

    - name: Deploy to Server
      shell: bash
      run: |
        set -e
        
        SSH_HOST="${{ inputs.ssh-host }}"
        SSH_USER="${{ inputs.ssh-user }}"
        IMAGE_URL="${{ steps.parse.outputs.image-url }}"
        VERSION="${{ inputs.version }}"
        ENVIRONMENT="${{ inputs.environment }}"
        
        echo "ðŸš€ Deploying to $ENVIRONMENT environment"
        echo "ðŸ“¦ Host: $SSH_HOST"
        echo "ðŸ‘¤ User: $SSH_USER"
        echo "ðŸ³ Image: $IMAGE_URL"
        echo "ðŸ·ï¸  Version: $VERSION"
        
        # Validate IMAGE_URL again
        if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" = "null" ]; then
          echo "âŒ Error: IMAGE_URL is empty or null after parsing"
          echo "Original input was: ${{ inputs.image-urls }}"
          exit 1
        fi
        
        # Create SSH key file
        mkdir -p ~/.ssh
        echo "${{ inputs.ssh-key }}" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Add host to known_hosts
        ssh-keyscan -H "$SSH_HOST" >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Copy deployment script to server
        echo "ðŸ“¤ Copying deployment script to server..."
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no /tmp/deploy.sh ${SSH_USER}@${SSH_HOST}:/tmp/deploy.sh
        
        # Execute deployment on server
        echo "ðŸš€ Executing deployment on server..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} << EOF
        export ENVIRONMENT="$ENVIRONMENT"
        export IMAGE_URL="$IMAGE_URL"
        export VERSION="$VERSION"
        export GITHUB_TOKEN="${{ inputs.github-token }}"
        export GITHUB_ACTOR="${{ github.actor }}"
        bash /tmp/deploy.sh
        EOF
        
        # Cleanup
        rm -f ~/.ssh/deploy_key /tmp/deploy.sh
        
        echo "âœ… Deployment to $ENVIRONMENT completed successfully!"
