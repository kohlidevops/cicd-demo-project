name: 'Deploy Docker Images'
description: 'Deploy Docker images to specified environment'

inputs:
  environment:
    description: 'Target environment (acceptance, qa, production)'
    required: true
  version:
    description: 'Version tag to deploy'
    required: true
  image-urls:
    description: 'JSON array of image URLs with digests or tags'
    required: true
  ssh-host:
    description: 'SSH host to deploy to'
    required: true
  ssh-user:
    description: 'SSH user'
    required: true
  ssh-key:
    description: 'SSH private key'
    required: true
  github-token:
    description: 'GitHub token for GHCR authentication'
    required: true

runs:
  using: "composite"
  steps:
    - name: Parse Image URLs
      id: parse
      shell: bash
      run: |
        echo "Parsing image URLs for deployment"
        IMAGE_URL=$(echo '${{ inputs.image-urls }}' | jq -r '.[0]')
        echo "image-url=$IMAGE_URL" >> $GITHUB_OUTPUT
        echo "Deploying: $IMAGE_URL"

    - name: Create Deployment Script
      shell: bash
      run: |
        cat > /tmp/deploy.sh << 'SCRIPT_END'
        #!/bin/bash
        set -e
        
        echo "ðŸš€ Starting deployment to $ENVIRONMENT"
        echo "ðŸ“¦ Image: $IMAGE_URL"
        echo "ðŸ·ï¸  Version: $VERSION"
        
        # Login to GHCR
        echo "$GITHUB_TOKEN" | docker login ghcr.io -u "$GITHUB_ACTOR" --password-stdin 2>&1 | grep -v "WARNING"
        
        # Pull new image
        echo "â¬‡ï¸  Pulling image..."
        docker pull "$IMAGE_URL"
        
        # Stop existing container
        echo "ðŸ›‘ Stopping existing container..."
        docker stop monolith-app 2>/dev/null || true
        docker rm monolith-app 2>/dev/null || true
        
        # Run new container
        echo "â–¶ï¸  Starting new container..."
        docker run -d \
          --name monolith-app \
          --restart unless-stopped \
          -p 3000:3000 \
          -e NODE_ENV=production \
          -e APP_VERSION="$VERSION" \
          "$IMAGE_URL"
        
        # Wait for application to start
        echo "â³ Waiting for application to start..."
        sleep 10
        
        # Verify deployment with health check
        echo "ðŸ¥ Running health check..."
        MAX_ATTEMPTS=30
        ATTEMPT=0
        
        while [ $ATTEMPT -lt $MAX_ATTEMPTS ]; do
          if curl -f http://localhost:3000/health 2>/dev/null; then
            echo "âœ… Health check passed!"
            echo "âœ… Deployment successful!"
            
            # Show container status
            echo ""
            echo "ðŸ“Š Container status:"
            docker ps --filter name=monolith-app
            
            # Cleanup old images
            echo ""
            echo "ðŸ§¹ Cleaning up old images..."
            docker image prune -af --filter "until=24h" 2>/dev/null || true
            
            echo ""
            echo "ðŸŽ‰ Deployment complete!"
            exit 0
          fi
          
          ATTEMPT=$((ATTEMPT + 1))
          echo "â³ Waiting for health check... attempt $ATTEMPT/$MAX_ATTEMPTS"
          sleep 2
        done
        
        echo "âŒ Health check failed after $MAX_ATTEMPTS attempts"
        echo "ðŸ“‹ Container logs:"
        docker logs monolith-app || true
        exit 1
        SCRIPT_END
        
        chmod +x /tmp/deploy.sh

    - name: Deploy to Server
      shell: bash
      env:
        SSH_HOST: ${{ inputs.ssh-host }}
        SSH_USER: ${{ inputs.ssh-user }}
        SSH_KEY: ${{ inputs.ssh-key }}
        IMAGE_URL: ${{ steps.parse.outputs.image-url }}
        VERSION: ${{ inputs.version }}
        ENVIRONMENT: ${{ inputs.environment }}
        GITHUB_TOKEN: ${{ inputs.github-token }}
        GITHUB_ACTOR: ${{ github.actor }}
      run: |
        set -e
        
        echo "ðŸš€ Deploying to $ENVIRONMENT environment"
        echo "ðŸ“¦ Host: $SSH_HOST"
        echo "ðŸ‘¤ User: $SSH_USER"
        echo "ðŸ³ Image: $IMAGE_URL"
        echo "ðŸ·ï¸  Version: $VERSION"
        
        # Validate IMAGE_URL
        if [ -z "$IMAGE_URL" ] || [ "$IMAGE_URL" = "null" ]; then
          echo "âŒ Error: IMAGE_URL is empty or null"
          exit 1
        fi
        
        # Create SSH key file
        mkdir -p ~/.ssh
        echo "$SSH_KEY" > ~/.ssh/deploy_key
        chmod 600 ~/.ssh/deploy_key
        
        # Add host to known_hosts
        ssh-keyscan -H $SSH_HOST >> ~/.ssh/known_hosts 2>/dev/null || true
        
        # Copy deployment script to server
        echo "ðŸ“¤ Copying deployment script to server..."
        scp -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no /tmp/deploy.sh ${SSH_USER}@${SSH_HOST}:/tmp/deploy.sh
        
        # Execute deployment script on server with environment variables
        echo "ðŸš€ Executing deployment on server..."
        ssh -i ~/.ssh/deploy_key -o StrictHostKeyChecking=no ${SSH_USER}@${SSH_HOST} \
          bash -c "export ENVIRONMENT='$ENVIRONMENT' IMAGE_URL='$IMAGE_URL' VERSION='$VERSION' GITHUB_TOKEN='$GITHUB_TOKEN' GITHUB_ACTOR='$GITHUB_ACTOR' && bash /tmp/deploy.sh"
        
        # Cleanup
        rm -f ~/.ssh/deploy_key /tmp/deploy.sh
        
        echo "âœ… Deployment to $ENVIRONMENT completed successfully!"
